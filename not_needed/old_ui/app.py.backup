import streamlit as st
import requests
import json
from datetime import datetime
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

# Import new modules
try:
    from ai_dashboard import show_ai_dashboard
    from calendar_system import show_calendar_system
    from notifications import show_notifications
    from note_templates import show_template_selector
    from language_support import show_language_selector, get_text, init_language
    from patient_dashboard import show_patient_dashboard
    from nurse_workspace import show_nurse_workspace
except ImportError:
    # If running from different directory
    import sys
    import os
    sys.path.insert(0, os.path.join(os.path.dirname(__file__)))
    from ai_dashboard import show_ai_dashboard
    from calendar_system import show_calendar_system
    from notifications import show_notifications
    from note_templates import show_template_selector
    from language_support import show_language_selector, get_text, init_language
    from patient_dashboard import show_patient_dashboard
    from nurse_workspace import show_nurse_workspace

# Initialize language support
init_language()

# Custom CSS for professional medical UI - Works on all platforms
CUSTOM_CSS = """
<style>
    /* Reset and base styles */
    * {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }
    
    /* Main background */
    .stApp {
        background-color: #f8f9fa !important;
    }
    
    /* All text should be dark and visible */
    body, p, span, div, label, li, td, th {
        color: #212529 !important;
        font-size: 16px !important;
    }
    
    /* Headers - clear hierarchy */
    h1 {
        color: #0d6efd !important;
        font-size: 2.5rem !important;
        font-weight: 700 !important;
        margin-bottom: 1rem !important;
    }
    
    h2 {
        color: #495057 !important;
        font-size: 2rem !important;
        font-weight: 600 !important;
        margin-top: 1.5rem !important;
        margin-bottom: 1rem !important;
    }
    
    h3 {
        color: #495057 !important;
        font-size: 1.5rem !important;
        font-weight: 600 !important;
    }
    
    /* Buttons - clear and clickable */
    .stButton > button {
        background-color: #0d6efd !important;
        color: white !important;
        border: none !important;
        border-radius: 6px !important;
        padding: 0.5rem 1rem !important;
        font-weight: 600 !important;
        font-size: 16px !important;
        cursor: pointer !important;
    }
    
    .stButton > button:hover {
        background-color: #0b5ed7 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    
    /* Form inputs - clear labels */
    label {
        color: #212529 !important;
        font-weight: 600 !important;
        font-size: 16px !important;
        margin-bottom: 0.5rem !important;
    }
    
    /* Input fields - FORCE DARK TEXT */
    input, textarea, select {
        border: 2px solid #dee2e6 !important;
        border-radius: 6px !important;
        padding: 0.5rem !important;
        font-size: 16px !important;
        color: #212529 !important;
        background-color: #ffffff !important;
    }
    
    /* Password fields specifically */
    input[type="password"] {
        color: #212529 !important;
        background-color: #ffffff !important;
        -webkit-text-fill-color: #212529 !important;
    }
    
    /* Select boxes / Dropdowns - FORCE DARK TEXT */
    [data-baseweb="select"] {
        background-color: #ffffff !important;
    }
    
    [data-baseweb="select"] > div {
        background-color: #ffffff !important;
        color: #212529 !important;
    }
    
    [data-baseweb="select"] span {
        color: #212529 !important;
    }
    
    /* Dropdown menu items - SUPER AGGRESSIVE TARGETING */
    [data-baseweb="menu"] {
        background-color: #ffffff !important;
    }
    
    [data-baseweb="menu"] li {
        color: #212529 !important;
        background-color: #ffffff !important;
    }
    
    [data-baseweb="menu"] li:hover {
        background-color: #e9ecef !important;
        color: #212529 !important;
    }
    
    [data-baseweb="menu"] ul {
        background-color: #ffffff !important;
    }
    
    [data-baseweb="menu"] li > div {
        color: #212529 !important;
    }
    
    /* Dropdown options text */
    [role="option"] {
        color: #212529 !important;
        background-color: #ffffff !important;
    }
    
    [role="option"]:hover {
        background-color: #e9ecef !important;
        color: #212529 !important;
    }
    
    [role="option"] span {
        color: #212529 !important;
    }
    
    /* Listbox items */
    [role="listbox"] {
        background-color: #ffffff !important;
    }
    
    [role="listbox"] li {
        color: #212529 !important;
        background-color: #ffffff !important;
    }
    
    /* Ensure all st.selectbox elements are visible */
    .stSelectbox > div > div {
        background-color: #ffffff !important;
        color: #212529 !important;
    }
    
    .stSelectbox label {
        color: #212529 !important;
    }
    
    /* Selectbox dropdown popup */
    .stSelectbox [data-baseweb="popover"] {
        background-color: #ffffff !important;
    }
    
    .stSelectbox [data-baseweb="popover"] > div {
        background-color: #ffffff !important;
    }
    
    /* All dropdown text */
    [data-baseweb="popover"] * {
        color: #212529 !important;
    }
    
    /* Force all select elements to be white background with dark text */
    .stSelectbox [data-baseweb="select"] > div {
        background-color: #ffffff !important;
        color: #212529 !important;
    }
    
    /* Selected option text */
    .stSelectbox [data-baseweb="select"] > div > div {
        color: #212529 !important;
    }
    
    /* Placeholder text */
    .stSelectbox [data-baseweb="select"] [role="button"] {
        color: #212529 !important;
        background-color: #ffffff !important;
    }
    
    /* All text inside select boxes */
    .stSelectbox * {
        color: #212529 !important;
    }
    
    /* Fix ALL button styles - ensure they're always visible */
    button, .stButton button, [data-testid="baseButton-secondary"] {
        background-color: #0d6efd !important;
        color: white !important;
        border: none !important;
        font-weight: 600 !important;
        min-height: 38px !important;
    }
    
    /* Secondary buttons */
    [data-testid="baseButton-secondary"] {
        background-color: #6c757d !important;
        color: white !important;
    }
    
    /* All text boxes and input areas */
    textarea, [data-baseweb="textarea"], .stTextArea textarea {
        background-color: #ffffff !important;
        color: #212529 !important;
        border: 2px solid #dee2e6 !important;
    }
    
    /* Date inputs */
    input[type="date"], input[type="time"] {
        background-color: #ffffff !important;
        color: #212529 !important;
    }
    
    /* Number inputs */
    input[type="number"] {
        background-color: #ffffff !important;
        color: #212529 !important;
    }
    
    /* All containers */
    .stContainer, [data-testid="stContainer"] {
        background-color: transparent !important;
    }
    
    /* Expander headers */
    .streamlit-expanderHeader {
        background-color: #ffffff !important;
        color: #212529 !important;
        border: 2px solid #dee2e6 !important;
    }
    
    /* Radio buttons and checkboxes - make labels visible */
    .stRadio label, .stCheckbox label {
        color: #212529 !important;
    }
    
    /* Multiselect */
    .stMultiSelect [data-baseweb="tag"] {
        background-color: #e7f1ff !important;
        color: #212529 !important;
    }
    
    /* Metrics - big and clear */
    [data-testid="stMetricValue"] {
        font-size: 2.5rem !important;
        font-weight: 700 !important;
        color: #0d6efd !important;
    }
    
    [data-testid="stMetricLabel"] {
        font-size: 1rem !important;
        color: #6c757d !important;
        font-weight: 600 !important;
    }
    
    /* Tabs - clear separation */
    .stTabs [data-baseweb="tab-list"] {
        gap: 4px !important;
        background-color: #e9ecef !important;
        padding: 4px !important;
        border-radius: 8px !important;
    }
    
    .stTabs [data-baseweb="tab"] {
        background-color: transparent !important;
        color: #495057 !important;
        border-radius: 6px !important;
        padding: 0.75rem 1.5rem !important;
        font-weight: 600 !important;
        font-size: 16px !important;
    }
    
    .stTabs [aria-selected="true"] {
        background-color: white !important;
        color: #0d6efd !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }
    
    /* Info/Success/Warning/Error boxes */
    .stAlert {
        border-radius: 8px !important;
        border: 2px solid !important;
        padding: 1rem !important;
    }
    
    .stSuccess {
        background-color: #d1e7dd !important;
        border-color: #0f5132 !important;
        color: #0f5132 !important;
    }
    
    .stInfo {
        background-color: #cfe2ff !important;
        border-color: #084298 !important;
        color: #084298 !important;
    }
    
    .stWarning {
        background-color: #fff3cd !important;
        border-color: #997404 !important;
        color: #997404 !important;
    }
    
    .stError {
        background-color: #f8d7da !important;
        border-color: #842029 !important;
        color: #842029 !important;
    }
    
    /* Expanders */
    .streamlit-expanderHeader {
        background-color: white !important;
        border: 2px solid #dee2e6 !important;
        border-radius: 8px !important;
        padding: 1rem !important;
        font-weight: 600 !important;
        color: #212529 !important;
        font-size: 16px !important;
    }
    
    /* DataFrames */
    .dataframe {
        font-size: 14px !important;
        color: #212529 !important;
    }
    
    /* Sidebar */
    [data-testid="stSidebar"] {
        background-color: #ffffff !important;
        border-right: 2px solid #dee2e6 !important;
    }
    
    /* Make sure ALL text is visible */
    .stMarkdown, .stText, .element-container {
        color: #212529 !important;
    }
    
    /* Container backgrounds */
    .element-container {
        background-color: transparent !important;
    }
</style>
"""

# Page configuration
st.set_page_config(
    page_title="Secure Medical Notes AI",
    page_icon="üè•",
    layout="wide",
    initial_sidebar_state="expanded"
)

# API Configuration
API_BASE_URL = "http://localhost:8000"

# Initialize session state
if 'access_token' not in st.session_state:
    st.session_state.access_token = None
if 'user_role' not in st.session_state:
    st.session_state.user_role = None
if 'user_name' not in st.session_state:
    st.session_state.user_name = None

def make_api_request(endpoint, method="GET", data=None, headers=None):
    """Make API request with error handling"""
    try:
        url = f"{API_BASE_URL}{endpoint}"
        if method == "GET":
            response = requests.get(url, headers=headers)
        elif method == "POST":
            response = requests.post(url, json=data, headers=headers)
        elif method == "PUT":
            response = requests.put(url, json=data, headers=headers)
        
        if response.status_code == 200:
            return response.json()
        else:
            st.error(f"API Error: {response.status_code} - {response.text}")
            return None
    except requests.exceptions.ConnectionError:
        st.error("Cannot connect to API. Make sure the API server is running on localhost:8000")
        return None

def login_user(email, password):
    """Login user and store token"""
    data = {"email": email, "password": password}
    response = make_api_request("/auth/login", method="POST", data=data)
    
    if response:
        st.session_state.access_token = response["access_token"]
        # Get user info (simplified - in real app, decode JWT)
        st.session_state.user_name = email.split("@")[0]
        
        # Determine role from email (in real app, decode from JWT)
        if "dr." in email.lower() or "doctor" in email.lower():
            st.session_state.user_role = "doctor"
        elif "nurse" in email.lower():
            st.session_state.user_role = "nurse"
        elif "admin" in email.lower():
            st.session_state.user_role = "admin"
        else:
            st.session_state.user_role = "staff"
        
        st.success(f"Login successful! Welcome {st.session_state.user_role.title()}!")
        return True
    return False

def logout_user():
    """Logout user and clear session"""
    st.session_state.access_token = None
    st.session_state.user_role = None
    st.session_state.user_name = None
    st.success("Logged out successfully!")

def get_auth_headers():
    """Get authorization headers for API requests"""
    if st.session_state.access_token:
        return {"Authorization": f"Bearer {st.session_state.access_token}"}
    return {}

# Main App
def main():
    # Apply custom CSS
    st.markdown(CUSTOM_CSS, unsafe_allow_html=True)
    
    # Enhanced Hero Header
    st.markdown("""
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 3rem 2rem; border-radius: 15px; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        <h1 style="color: white !important; font-size: 3.5rem !important; margin: 0 !important; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
            üè• Secure Medical Notes AI
        </h1>
        <p style="color: rgba(255,255,255,0.95) !important; font-size: 1.3rem !important; text-align: center; margin-top: 1rem !important; font-weight: 500;">
            AI-Powered Clinical Documentation Platform for Healthcare Excellence
        </p>
        <div style="text-align: center; margin-top: 1.5rem;">
            <span style="background-color: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; color: white; margin: 0 0.5rem; font-size: 0.9rem;">
                üîí HIPAA Compliant
            </span>
            <span style="background-color: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; color: white; margin: 0 0.5rem; font-size: 0.9rem;">
                ü§ñ AI-Powered
            </span>
            <span style="background-color: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; color: white; margin: 0 0.5rem; font-size: 0.9rem;">
                üìä Real-time Analytics
            </span>
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # Sidebar for authentication
    with st.sidebar:
        st.header("Authentication")
        
        if not st.session_state.access_token:
            st.subheader("Login")
            
            # Quick login buttons
            st.markdown("**Quick Login:**")
            col1, col2 = st.columns(2)
            
            with col1:
                if st.button("üë®‚Äç‚öïÔ∏è Doctor Login", use_container_width=True):
                    if login_user("dr.smith@hospital.com", "password123"):
                        st.rerun()
            
            with col2:
                if st.button("üë©‚Äç‚öïÔ∏è Nurse Login", use_container_width=True):
                    if login_user("nurse.johnson@hospital.com", "password123"):
                        st.rerun()
            
            st.markdown("---")
            st.markdown("**Or login manually:**")
            
            with st.form("login_form"):
                email = st.text_input("Email")
                password = st.text_input("Password", type="password")
                submit = st.form_submit_button("Login")
                
                if submit:
                    if login_user(email, password):
                        st.rerun()
        else:
            st.success(f"Logged in as: {st.session_state.user_name}")
            if st.button("Logout"):
                logout_user()
                st.rerun()
        
        # Language selector
        show_language_selector()
    
    # Main content based on authentication status
    if not st.session_state.access_token:
        st.markdown("""
        <div style="background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 1.5rem; border-radius: 8px; margin: 2rem 0;">
            <h3 style="color: #856404 !important; margin-top: 0;">üîê Please Login to Continue</h3>
            <p style="color: #856404 !important; font-size: 1.1rem;">Use the quick login buttons in the sidebar or enter your credentials manually.</p>
        </div>
        """, unsafe_allow_html=True)
        
        # Feature showcase
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.markdown("""
            <div style="background-color: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: 250px;">
                <h2 style="color: #0d6efd !important; text-align: center;">üìù</h2>
                <h3 style="color: #212529 !important; text-align: center;">Smart Documentation</h3>
                <p style="color: #6c757d !important; text-align: center;">
                    Create and manage clinical notes with pre-built templates and AI-powered suggestions
                </p>
            </div>
            """, unsafe_allow_html=True)
        
        with col2:
            st.markdown("""
            <div style="background-color: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: 250px;">
                <h2 style="color: #198754 !important; text-align: center;">ü§ñ</h2>
                <h3 style="color: #212529 !important; text-align: center;">AI Analysis</h3>
                <p style="color: #6c757d !important; text-align: center;">
                    Automatic summarization, risk assessment, and clinical insights powered by GPT-4
                </p>
            </div>
            """, unsafe_allow_html=True)
        
        with col3:
            st.markdown("""
            <div style="background-color: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: 250px;">
                <h2 style="color: #dc3545 !important; text-align: center;">üîí</h2>
                <h3 style="color: #212529 !important; text-align: center;">Enterprise Security</h3>
                <p style="color: #6c757d !important; text-align: center;">
                    HIPAA-compliant with role-based access, encryption, and complete audit trails
                </p>
            </div>
            """, unsafe_allow_html=True)
        
        st.markdown("<br>", unsafe_allow_html=True)
        
        # Additional features
        st.markdown("""
        <div style="background-color: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 2rem;">
            <h3 style="color: #212529 !important;">‚ú® Key Features</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                <div style="color: #212529 !important;">‚úÖ <strong>Role-Based Access</strong> - Separate workflows for doctors and nurses</div>
                <div style="color: #212529 !important;">‚úÖ <strong>Patient Dashboard</strong> - Comprehensive patient history and insights</div>
                <div style="color: #212529 !important;">‚úÖ <strong>Calendar System</strong> - Manage appointments and follow-ups</div>
                <div style="color: #212529 !important;">‚úÖ <strong>Real-time Notifications</strong> - Stay updated on critical events</div>
                <div style="color: #212529 !important;">‚úÖ <strong>Multi-language Support</strong> - Available in multiple languages</div>
                <div style="color: #212529 !important;">‚úÖ <strong>Report Generation</strong> - Automated PDF reports and analytics</div>
            </div>
        </div>
        """, unsafe_allow_html=True)
    else:
        # Role-based tabs
        user_role = st.session_state.get('user_role', 'staff')
        
        if user_role == "doctor":
            # Doctor-specific tabs
            tab1, tab2, tab3, tab4, tab5, tab6, tab7, tab8 = st.tabs([
                "üë• Patients",
                "üìã Doctor Notes", 
                "ü§ñ AI Dashboard", 
                "üìÖ Calendar", 
                "üìä Summaries", 
                "‚ö†Ô∏è Risk Reports", 
                "üîî Notifications",
                "üìù Audit Trail"
            ])
        elif user_role == "nurse":
            # Nurse-specific tabs
            tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
                "üë• Patients",
                "üë©‚Äç‚öïÔ∏è Nurse Workspace", 
                "üìÖ Calendar", 
                "üìä View Summaries", 
                "üîî Notifications",
                "üìù Notes History"
            ])
        else:
            # Admin or other roles - show all
            tab1, tab2, tab3, tab4, tab5, tab6, tab7, tab8, tab9 = st.tabs([
                "üë• Patients",
                "üìã Doctor Notes", 
                "üë©‚Äç‚öïÔ∏è Nurse Notes", 
                "ü§ñ AI Dashboard", 
                "üìÖ Calendar", 
                "üìä Summaries", 
                "‚ö†Ô∏è Risk Reports", 
                "üîî Notifications",
                "üìù Audit Trail"
            ])
        
        with tab1:
            # Patient Dashboard
            show_patient_dashboard(API_BASE_URL, st.session_state.access_token)
        
        with tab2:
            st.header("Doctor Notes Management")
            
            col1, col2 = st.columns([2, 1])
            
            with col1:
                st.subheader("Create New Note")
                
                # Template selector
                template_content = show_template_selector()
                
                with st.form("doctor_note_form"):
                    patient_id = st.text_input("Patient ID")
                    title = st.text_input("Note Title")
                    content = st.text_area("Note Content", value=template_content, height=200)
                    submit = st.form_submit_button("Create Note")
                    
                    if submit:
                        if patient_id and title and content:
                            data = {
                                "patient_id": int(patient_id) if patient_id.isdigit() else 1,
                                "title": title,
                                "content": content,
                                "note_type": "doctor_note"
                            }
                            response = make_api_request(
                                "/notes/", 
                                method="POST", 
                                data=data, 
                                headers=get_auth_headers()
                            )
                            if response:
                                st.success("Note created successfully!")
                        else:
                            st.error("Please fill in all fields")
            
            with col2:
                st.subheader("Recent Notes")
                notes = make_api_request("/notes/", headers=get_auth_headers())
                if notes:
                    for note in notes[:5]:  # Show last 5 notes
                        with st.expander(f"{note['title']} - {note['created_at'][:10]}"):
                            st.write(f"**Type:** {note['note_type']}")
                            st.write(f"**Patient:** {note['patient_name']}")
                            st.write(f"**Author:** {note['author_name']}")
                            if note['summary']:
                                st.write(f"**Summary:** {note['summary']}")
        
        with tab3:
            # Comprehensive Nurse Workspace
            show_nurse_workspace(API_BASE_URL, st.session_state.access_token)
        
        with tab4:
            # AI Dashboard
            show_ai_dashboard()
        
        with tab5:
            # Calendar System
            show_calendar_system()
        
        with tab6:
            st.header("AI-Generated Summaries")
            
            # AI Status Check
            ai_status = make_api_request("/ai/ai-status", headers=get_auth_headers())
            if ai_status and ai_status.get("status") == "operational":
                st.success("‚úÖ AI Services: Operational")
            else:
                st.error("‚ùå AI Services: Not Available - Check OpenAI API key")
            
            # Batch processing controls
            col1, col2, col3 = st.columns([2, 1, 1])
            
            with col1:
                st.subheader("AI Processing")
            
            with col2:
                if st.button("üîÑ Process All Notes", help="Run AI summarization on all notes"):
                    with st.spinner("Processing notes with AI..."):
                        notes = make_api_request("/notes/", headers=get_auth_headers())
                        if notes:
                            note_ids = [note['id'] for note in notes if not note.get('summary')]
                            if note_ids:
                                response = make_api_request(
                                    "/ai/batch-summarize", 
                                    method="POST", 
                                    data={"note_ids": note_ids}, 
                                    headers=get_auth_headers()
                                )
                                if response:
                                    st.success(f"Processed {len(note_ids)} notes!")
                                    st.rerun()
                            else:
                                st.info("All notes already processed!")
            
            with col3:
                if st.button("üîÑ Refresh", help="Refresh the summaries view"):
                    st.rerun()
            
            # Get notes with summaries
            notes = make_api_request("/notes/", headers=get_auth_headers())
            if notes:
                summarized_notes = [n for n in notes if n.get('summary')]
                unprocessed_notes = [n for n in notes if not n.get('summary')]
                
                if summarized_notes:
                    st.subheader(f"üìä AI-Processed Notes ({len(summarized_notes)})")
                    for note in summarized_notes:
                        with st.expander(f"üìÑ {note['title']} - {note['created_at'][:10]}"):
                            col1, col2 = st.columns([2, 1])
                            
                            with col1:
                                st.write("**AI Summary:**")
                                st.write(note['summary'])
                                
                                if note.get('recommendations'):
                                    st.write("**AI Recommendations:**")
                                    st.write(note['recommendations'])
                            
                            with col2:
                                if note.get('risk_level'):
                                    risk_color = "red" if note['risk_level'].lower() == 'high' else "orange" if note['risk_level'].lower() == 'medium' else "green"
                                    st.markdown(f"**Risk Level:** :{risk_color}[{note['risk_level']}]")
                                
                                if note.get('tags'):
                                    st.write("**Tags:**")
                                    tags = note['tags'].split(',') if note['tags'] else []
                                    for tag in tags:
                                        st.write(f"‚Ä¢ {tag.strip()}")
                
                if unprocessed_notes:
                    st.subheader(f"‚è≥ Unprocessed Notes ({len(unprocessed_notes)})")
                    for note in unprocessed_notes[:5]:  # Show first 5
                        with st.expander(f"üìù {note['title']} - {note['created_at'][:10]} (Click to process)"):
                            if st.button(f"ü§ñ Process with AI", key=f"process_{note['id']}"):
                                with st.spinner("Processing with AI..."):
                                    response = make_api_request(
                                        f"/ai/summarize/{note['id']}", 
                                        method="POST", 
                                        headers=get_auth_headers()
                                    )
                                    if response:
                                        st.success("Note processed successfully!")
                                        st.rerun()
            else:
                st.warning("No notes available for summarization")
        
        with tab7:
            st.header("Risk Assessment & Reports")
            
            # High-risk patients overview
            high_risk_data = make_api_request("/ai/high-risk-patients", headers=get_auth_headers())
            
            if high_risk_data and high_risk_data.get("high_risk_patients"):
                high_risk_patients = high_risk_data["high_risk_patients"]
                
                # Risk metrics
                col1, col2, col3, col4 = st.columns(4)
                
                with col1:
                    critical_count = len([p for p in high_risk_patients if p.get('risk_level') == 'CRITICAL'])
                    st.metric("Critical Risk", critical_count, "patients")
                
                with col2:
                    high_count = len([p for p in high_risk_patients if p.get('risk_level') == 'HIGH'])
                    st.metric("High Risk", high_count, "patients")
                
                with col3:
                    medium_count = len([p for p in high_risk_patients if p.get('risk_level') == 'MEDIUM'])
                    st.metric("Medium Risk", medium_count, "patients")
                
                with col4:
                    st.metric("Total Monitored", len(high_risk_patients), "patients")
                
                # High-risk patients list
                st.subheader("üö® High-Risk Patients")
                for patient in high_risk_patients:
                    risk_color = "red" if patient.get('risk_level') in ['HIGH', 'CRITICAL'] else "orange"
                    with st.expander(f":{risk_color}[{patient.get('risk_level', 'UNKNOWN')}] {patient.get('patient_name', 'Unknown')} - {patient.get('last_note_date', '')[:10]}"):
                        st.write(f"**Patient ID:** {patient.get('patient_id', 'N/A')}")
                        st.write(f"**Last Note:** {patient.get('last_note_title', 'N/A')}")
                        if patient.get('recommendations'):
                            st.write("**Recommendations:**")
                            st.write(patient['recommendations'])
            else:
                st.info("No high-risk patients identified. Run AI processing on notes to generate risk assessments.")
            
            # Individual patient risk report
            st.subheader("üìä Individual Patient Risk Report")
            patient_id = st.text_input("Enter Patient ID for detailed risk report", placeholder="e.g., 1")
            
            if st.button("Generate Risk Report") and patient_id:
                with st.spinner("Generating comprehensive risk report..."):
                    risk_report = make_api_request(f"/ai/risk-report/{patient_id}", headers=get_auth_headers())
                    
                    if risk_report and not risk_report.get("error"):
                        st.success(f"Risk report generated for {risk_report.get('patient_name', 'Unknown')}")
                        
                        # Display risk report
                        col1, col2 = st.columns([2, 1])
                        
                        with col1:
                            st.write("**Risk Analysis:**")
                            st.write(risk_report.get('summary', 'No analysis available'))
                            
                            if risk_report.get('risks'):
                                st.write("**Identified Risk Factors:**")
                                for risk in risk_report['risks']:
                                    st.write(f"‚Ä¢ {risk}")
                        
                        with col2:
                            risk_level = risk_report.get('risk_level', 'UNKNOWN')
                            risk_color = "red" if risk_level in ['HIGH', 'CRITICAL'] else "orange" if risk_level == 'MEDIUM' else "green"
                            st.markdown(f"**Overall Risk:** :{risk_color}[{risk_level}]")
                            
                            if risk_report.get('recommendations'):
                                st.write("**Recommendations:**")
                                for rec in risk_report['recommendations']:
                                    st.write(f"‚Ä¢ {rec}")
                        
                        # Trends
                        if risk_report.get('trends'):
                            st.write("**Risk Trends:**")
                            trends_df = pd.DataFrame(risk_report['trends'])
                            st.dataframe(trends_df, use_container_width=True)
                    else:
                        st.error(f"Error generating risk report: {risk_report.get('error', 'Unknown error')}")
        
        with tab8:
            # Notifications System
            show_notifications()
        
        with tab9:
            st.header("Audit Trail & Compliance")
            
            st.info("üöß Audit logging will be implemented for compliance tracking")
            
            # Placeholder for audit logs
            st.markdown("""
            ### Audit Trail Features:
            - **Complete access logs** for all patient data
            - **Immutable audit records** with hash chaining
            - **Compliance reporting** for HIPAA requirements
            - **User activity monitoring** and alerts
            """)
            
            # Sample audit log display
            audit_data = {
                "Timestamp": ["2024-01-15 10:30:00", "2024-01-15 10:25:00", "2024-01-15 10:20:00"],
                "User": ["Dr. Smith", "Nurse Johnson", "Dr. Smith"],
                "Action": ["Created Note", "Viewed Patient", "Updated Note"],
                "Resource": ["Note #123", "Patient #456", "Note #123"],
                "IP Address": ["192.168.1.100", "192.168.1.101", "192.168.1.100"]
            }
            
            df = pd.DataFrame(audit_data)
            st.dataframe(df, use_container_width=True)

if __name__ == "__main__":
    main()